---
layout: post
title: 「PCのハードウェアクロックが狂ってるとしっちゃかめっちゃかになる」話
category: tech
tags: [hardware,problem,tips,linux,ubuntu]
---

技術的検証も、ハードコピーも、なーにも出来てないんですけど…

ともかく！ 「こんな事象になるんだ…」という「トラブった時疑うべき点」となる「貴重な体験」をしたっぽいので、あわててブログ書きました。

# 現象

ハードウェアクロック(マザーボード内の水晶振動体時計)が、とてつもない未来(今回遭遇した例では"2172年")に設定された状態では、
コンピュータの動作に著しい支障をきたす。

## 遭遇した環境

+ Linux(UbuntuLinux)
  + たまたまそうだが、事象から考えるにOSを問わなそう(未検証)
+ ノートPC(例の[Chromebock "Asus C300MA"](http://kazuhito-m.github.io/tech/2015/10/04/choromebook-c300ma-ubuntu-boot/))

## 遭遇した問題

+ DHCPサーバから、IPを取得できない
+ DHCPサーバから、プライマリDNSが取れない
+ 手動でIP、DNSサーバを設定しても名前解決が出来ない
+ 証明書が役立たず(HTTPS/SSL通信が出来ない)
+ NTPサーバを設定していたとしても「ネット繋がらない」ので自動補正効かず解決に向かわない
+ 電源切ると「ハードクロック側」を最初に参照するのでシステムクロックを補正してもまたおかしくなる
+ Linux的には
  + パッケージ管理がズタボロ(出来たり出来なかったりするので依存性がむちゃくちゃに)
  + Ubuntuのディストリインストーラが途中でこける

おそらくは「TTL(Time to live)のような"発行時間"と"有効期間(寿命)"のような概念」があるものが軒並みやられる感じ。

## 経緯

しばらく電源をつけてなかったマシンで、電源をつけるとハードウェアクロックが超絶未来になっていた。

設定も変えてない上「まさか時計の狂いぐらいで挙動に著しい支障をきたす」と思っていないため、原因をそこに見いだせず、ドハマリ。

(その間、めっちゃ時間をかけてインストールしたり、ディストリのバージョンを3つくらい行き来してみたり…の試行錯誤。)

# 対処(解決策)

インストーラが動かないせいで「内部ディスクのOSは当てにならない」状態となってしまったため、
USBメモリブータブルUbuntuLinuxを起動させ、そこで作業を行いました。

最初の時点で、どうやら日付がおかしい…。

```bash
date
2172年 10月 21日 水曜日 06:26:37 JST
```
DNSの名前解決をすると、以下のような状態になり、名前が引けません。

```bash
host google.co.jp
timer.c:811: fatal error: RUNTIME_CHECK(isc_time_now((&now)) == 0) failed
中止 (コアダンプ)
```

ここで「timer.c ... ?」という疑いから、原因に辿りつけたのですけど…。

---

まず、システムクロック(ソフトウェア上の時間)を、「出来る限り現在の時間」に寄せて、補正しました。

```bash
sudo date --set '2015-11-04 23:15:00' # 正確でなくても良いです。ある程度寄ってれば…
```

この時点で、DHCPでのIP取得とDNSでの名前解決が復活します。

```bash
host google.co.jp
google.co.jp has address 216.58.221.3
google.co.jp mail is handled by 30 alt2.aspmx.l.google.com.
google.co.jp mail is handled by 40 alt3.aspmx.l.google.com.
...
```
よし、復活！…なのですが、インターネット参照が復活していることから、
NTPでの「時間合わせ」も復活してることをGUIで確認します。

![]()
