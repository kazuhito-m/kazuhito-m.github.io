---
layout: post
title: いろふさんの"ふんいきbot"、作って動かしてみた#irof_history
category: tech
tags: [coffeescript、Kuromoji, conscript, docker, github, heroku, irof, jsorp, redis, ubuntu, hubot]
---

この記事は、いろふ Advent Calendar 2014 その６日目の記事です。

昨日は、@yy_yank さんの 「マジ感謝ないろふさんに俺のライムを送る」でした。

---

__ザ・ワールド イズ ワンダフろふ__ 、ども、毎年お馴染み [@kazuhito_m](https://twitter.com/kazuhito_m) こと"みうみう"です。

これを見てるってことは、みなさま今年も"いろふェンシブ"な年末をお送りのことかと存じます。

# さーて、今年はどうすっかねー

いろふアドベントカレンダーも今年で三年目。

３年前ちょうどその初めてのアドカレを書いていた前後、その頃から勉強会などに行き始めた三浦としては、

- [2012年、いろふさんなら横でビルドしてるけど#irof_history](/tech/2012/12/08/irof-build)
- [2012年、「いろふさん絵描き歌」歌ってみた #irof_history](/tech/2012/12/24/singing-irof)
- [2013年、"性善説"いろふさん登場！ #irof_history](/tech/2013/12/06/fundamentally-good-irof)
- [2013年、「いろふさん絵描き歌」じゃないヤツ、歌ってみた #irof_history](/tech/2013/12/18/singing-irof-without-canvas)

と、「アドベントカレンダーなんて何か知らない」とこから、手法問わず様々な形で"いろふさん"というモノを表現し、 順調に「いろふの階段」を駆け上がってきた訳ですが…。

今年は「いろふの本丸」とも言うべき、"Twitter上のいろふさん" を攻めて見ようかな？と思い立ったのです。

そう…

# "ふんいきbot"

を作ろうとね。

---

## その、"ふんいきbot" って何さ！？

説明しよう、"ふんいきbot" とは…

厳密には違うけど、よくよく見てみると

「あー、言いそうかも？…いや、言わんかな…やっぱ、でも…」

くらいな雰囲気の言葉を醸し出す、TwitterBotである。

…いや、厳密にやろうとおもうと「強大な叡智と莫大な労力」が掛かると思うのよw

なので「まあ…見えなくもないよ」くらいのものを作ろっかなと。


## 作るにあたっての「コンセプト」

1. 人のフンドシでヨコズナ相撲
0. 自力で頑張らない(他力本願)
0. 何事も"雰囲気"大事

という「全力で世の中に甘えていくスタイルで」考えてみました。

## 「ところでTwitter見てくれ、コイツをどう思う？」

まずは、[どんなもん](https://twitter.com/irof_bot)になったのか、手っ取り早く見てもらいましょうかね…。

![定期的なつぶやき](/images/2014-12-06-interval.png)


(当人の中で)割とタイムリーな話題を言うてきます。 一時間に二回くらい。(今までツイート数当たりの時間が大体それくらい)


![反応](/images/2014-12-06-reflection.png)

「なんか言え！」みたいな無意味な煽りにも「全力で返していく」スタイルですｗ

![時刻](/images/2014-12-06-time.png)

「もーまた遅刻して…(当人が遅れないとは言っていない)」と俺に良く言うのざき氏、時間は重要のようで…。

時刻を聞いても、わりとざっくばらんに教えてくれますｗ

![クロール依頼](/images/2014-12-06-crole.png)

謎単語が行き交う会話も…。

いったいどういうことだってばよ！
大したことはしていませんw

予め「ああ、言いそう…言いそう…かなぁ？」くらいのテンプレートを一定間隔でランダムに喋らせています。

例：

- '本当の#{first_person}なら、そういうことは言わないな。'
- '本日は#{noun}関係でアレ。'
- '#{noun}とはなんだったのか。'

ただ、それだけだと、全然"ふんいきbot"ではないので、

1. 過去ツイート1000件を形態素解析にかける
0. 有名詞と一般名詞で頻出100位以下のものを束で持っておく
0. テンプレの名詞部分をランダムに置き換え

しています。

(昨年のいろふアドベントでの「[ぽざうねさんのアイディア](http://posaune.hatenablog.com/entry/2013/12/01/220555)」丸パクリですね。わかりますｗ)

また、その「解析かけて100件にして保存してくれる」という、いわゆる"クローラ"も設けており、一日一回定期実行するとともに「クロールし」というメンションを送れば実行、という風にもしてあります。

## 作ったもの

…ということをしてくれるのに必要な一式を、Dockerにくるんで「キット化」しましたｗ

![全体図](/images/2014-12-06-stracture.png)

### [funiki-bot-kit(Dockerfile と ファイル群)](https://github.com/kazuhito-m/dockers/tree/master/funiki_bot_kit)

- Dockerfileと自作スクリプトが2丁、計３テキストファイル群
- ビルドするための設計図
- 1Docker:1Bot(1アカウント)に対応
- (後述の)自作の道具はビルド時に同梱され、プロダクト(Node.js,Redisとか)含めその時の最新が入る

### [funiki-hubot](https://github.com/kazuhito-m/funiki-hubot/)

- しゃべってるbotの本体
- タイマーorメンションでRedisからデータ読んで仕事してる
- Hubot + Redis + 自作shell + 自作Coffeeスクリプト、という構成

### [funiki-crawler](https://github.com/kazuhito-m/funiki-crawler)

- 過去ツイートを取得・集計・解析するクロウラー
- Twilogサイトをスクレイプし、Redisにデータを蓄える
- Kuromoji(形態素解析) + JSorp + Redisclient + consclipt + 自作Scalaプログラム、という構成
- consclipt のおかげで「実行するたび最新」に

…もういろふさん関係ねえなw

## 必要要件

- 入れるサーバにDockerとgitクライアントがある
- 入れるサーバがインターネットに繋がる
- 入れる人がLinuxコマンド打てる
- ターゲット(まあいろふさんでしょう)が、Twilogサイトに登録してる
- ターゲット(まあいろふさんでしょう)に、入れる人が嫌われていない

## (おそらく誰も必要無い)インストール方法

[こちら](https://github.com/kazuhito-m/dockers/tree/master/funiki_bot_kit) に書いておきます。

## みうみうなんでやったん？

- OSSと自作の組み合わせの「全量見通せて自分でも手を入れられる」ような「botキット」が自分の手に一つ欲しかったから

おそらく「類似のサービス」も「それより高度なボットキット」もあるとは思うんです。

でも、そういうのって「中に手を入れ」たり「どこかに何かを挟ん」だりとかはできにくそうだなっと。

「自分が全て知って」て「ノウハウ蓄え」れて「増築出来る」"土台"が欲しかったんです。で稚拙ながら今回車輪の再開発してみました。

- あとは「自分のすきなようにしゃべらせられるいろふさん」がいれば

ま、一週間で仕事の片手間じゃこんな程度のもんしかできませんでしたですはい。

# TODO

## どっか外でホスティング

「自力で頑張らない(他力本願)」って言うたのに！Docker回すサーバは自宅でしてしまいました。

できればHerokuとか外のやつにやらせておきたいなと。

## メンション飛ばした時のリアクション
今は「ある単語の場合反応する」で、ココは作りこんでいない。 まー某「別のアドベントカレンダー」でやるとか…ゴニョゴニョ

## 参考資料

[ここ](https://github.com/kazuhito-m/funiki-crawler/wiki/Refalence-links)とか[ここ](https://github.com/kazuhito-m/funiki-hubot/wiki/refalence-links)とかスクラップ。

# 所感・感想

- Redisが超便利(今回のような条件なら)
- 不得意な言語の上、行き来したので辛かった
- いろふさんの「雰囲気醸す」ってのが、途中でゲシュタルト崩壊してよくわからんようになった
- 「夢想」から「実現」までの時間が遠すぎて…もっと幅とスピードが欲しいなと思った

これで皆さんも、ご自宅に「Dockerコンテナ一つ」あれば、１いろふさんを招き入れられますね♪

皆様も「思い思いのいろふさんbot」を作ってみてはいかがでしょうか。

# PS:

ん？ [ネタかぶり](http://tenten0213.hatenablog.com/entry/2014/12/04/072017) ？ ご冗談をw

---

明日は、きつねさん( [@bitter_fox](https://twitter.com/bitter_fox) )の「[きつねとJava！](http://d.hatena.ne.jp/bitter_fox/20141207/1417928871)」です。(一度会ってみたい方ですね…)
