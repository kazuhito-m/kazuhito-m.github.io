---
layout: post
title: Pasori＆Ferica2Moneyを使ってのフェリカ履歴データのGnuCash取込
category: tech
tags: [gnucash,ferica,rfid,pasori,windows,felica2money]
---

![全景](/images/2011-04-18-import-gnucash-from-ferica.jpg)

タイトルがわけわかりませんが、

__「RFIDリーダを使ったＩＣＯＣＡ履歴をGnuCashへ読み込む方法」__

です。

GnuCash情報の老舗、このサイトの方曰く「出来る」と言ってる（ぽい？）ので、RFIDリーダ「Pasori」を買ってみました。

[過去記事:GnuCashレビュー](/tech/2011/04/17/review-gnucash)

それでは、説明を…

# 前提

- Windowsでの作業(XP SP3)
- もちろんGnuCashもWin版(2.4.4)
- Pasoriは後期版(黒)のRC-S370

次は手順です、

# 手順

## Pasori(RC-S370)のドライバ＆ソフトのインストール

RFIDリーダであるPasoriをUSBでPCに繋ぎます。

XPなら繋いだ途端、自動でドライバ＆ソフトインストールしました。 ※本筋じゃないので端折ります。

## FeliCa2Moneyをダウンロード＆インストール

[こちら](http://felica2money.tmurakam.org/)からソフトをダウンロードします。

インストールして下さい。

ここらへんではハマる要素は無い…と思う。

## FeliCa2Moneyを起動、設定を行う。

ソフトが立ち上がったら、以下の設定をしてください。

※赤い囲みの部分

![全景](/images/2011-04-18-option.jpg)


- 「OFXファイル名を主動で設定する」＞ On
  - 保存場所を指定しない設定にすると、無言で終了します。
  - (どこに保存しているんだろう…？)
- 「保存後にOFXファイルを自動的に起動する」＞ Off
  - ウチのようにMSMoneyと同時にインスコしているところにはこの設定が必要です。
  - (そんなヒト一握りでしょうけど、念のため）
- 「Ver2.0のOFXファイル(XML)を生成する ＞ Off
  - GnuCash側が対応していません。※後述

その他、JRのカードを読ませたい方は、上部のエリア選択を行って置いてください。
設定が終われば「OK」ボタンをクリックして設定画面を閉じてください。

## Pasoriにカードをセットして履歴をOFXファイル出力

カードをセットして、各種対応するボタンをクリックしてください。

※俺はＩＣＯＣＡなので、上から二番目のボタンを押下しました。

ファイル選択のダイアログが表示されるので、保存するファイルの場所・名前を指定してください。

## GnuCashを起動しOFXファイルを読み込ませる

起動させたら、「ファイル(F)→インポート(I)→OFX/QFXファイルをインポート」をクリック、ファイルを選んでください。

「勘定科目を選択」の選択画面で科目を選んだ後、「汎用インポート取引マッチング」画面が表示されます。

![汎用インポート取引マッチング](/images/2011-04-18-import-view.jpg)

個々、右端の「情報」欄をクリックして、「入金」と「出金」の仕訳をしてください。

俺の場合、「財布」と「交通費」の科目を割り当てているので、そこへ振りました。

※2回目からは楽になる…かも？しれませんｗ

# ハマり点

上記の「Ver2.0のOFXファイル(XML)」にGnuCash側が対応していないのを解らず、「ど～～足掻いても文字化けする！」と延々とハマっていました。

ようやく、他の読めたファイルとの違いを探り「ヘッダ部が違う！」と突き止めました。

2.0のファイル

```xml
<?xml version="1.0" encoding="shift_jis" standalone="yes"?>
<?OFX OFXHEADER="200" VERSION="200" SECURITY="NONE" OLDFILEUID="NONE" NEWFILEUID="NONE"?>
```

2.0以前のファイル

```xml
OFXHEADER:100
DATA:OFXSGML
VERSION:102
SECURITY:NONE
ENCODING:UTF-8
CHARSET:CSUNICODE
COMPRESSION:NONE
OLDFILEUID:NONE
NEWFILEUID:NONE
```

コレを差し替えると上手くいき、後で「バージョンか！」と気づいて設定を変えるとここが変化することを確かめました。

---

# 小並感

…まあ「全てを手入力しなくて良い」だけで、判断と実際の仕訳には人間系が必要なのは変わりませんが。

間違いがなくなることと、少しでも省力化できるのは俺好みかと。


しかし…履歴は20件なんですね。

一週間に一回、読み込ませないといけないな…ルール化するか。
