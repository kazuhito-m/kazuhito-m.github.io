---
published: false
layout: post
title: SSHトンネリングしたFirefoxを使ってブラウジングする「作業用端末」をDockerで再現する
category: tech
tags: [docker,firefox,infrastructur,iac]
---

これは [#インフラ勉強会](https://wp.infra-workshop.tech) の [アドベントカレンダー](https://adventar.org/calendars/3022) の三日目です。

前日、二日目は「 [まみー](https://twitter.com/mamy1326) さんの []() 」でした。

---

自身はプログラマなので、インフラについては「運用に居たことがある」「クラウドの設計することがある」という立場からの参加ですが、今回は「運用やってると各現場に一つはありそう」な、

「特殊用途の固定作業用端末」

のお話です。

# これを読んで得られるもの

- 業務で使う「限定された作業用端末」をDockerを使い配布する方法
  - SSHトンネリングでブラウジングする端末をDockerで作成する方法

# 経緯

会社と仕事をしてると「内規で使わなければならないWebアプリケーションがある」とかあると思います。

しかもそれが「社内ネットワークからのみアクセス可能」だったり「IPを固定してそこからしかアクセスさせません」だったりすることがありますね。

実際、最近も

- 発注側からは「仕事の内容を特定の情報サイト(Webアプリ)を使って閲覧・書き込みするように」と指定がある
- 発注側の上記サイトは「固定IPからしかアクセスを許可しない」
- 自分(みうら)は「受注側」の企業の拠点、あるいは「その拠点に繋がる場所」で仕事をしており、かつ「発注側の情報サイトを使う仕事」がある

という条件なので、以下のような形態で仕事をしていました。

![ネットワークと仕事全体像](/images/2018-12-03-network-and-work.png)

SSH(鍵認証)で入ることが出来るサーバを用意し固定IPを付け、そこを踏み台として「拠点の固定端末」or「(みうらの)自宅の作業PC」から、情報サイト(Webアプリ)にアクセスしていました。

「サイトを見るためのサーバを用意する」というのも手間ですが、改善したかったのは「特殊な設定をした固定端末やPC」の方で、今回はそれを扱います。

![固定端末やPC](/images/2018-12-03-special-console.png)

- 拠点に固定で物理端末を置いている
- 外部からアクセスするときには、「ブラウザの設定やポートフォワーディングを仕込む”手順書”に従った作業をする」
- 上記手順に従って設定すると「環境を汚す」

ということから「この端末の用意をDockerで出来ないか」と思ってやってみました。

# やったこと

## どんなものを作ったのか

こちらにあります。

<https://github.com/kazuhito-m/dockers/tree/master/portforwarding-webbrowsing>


# 所感

「特殊な設定(トンネリングを仕込む、など)をした端末」って、サービスのメンテでもインフラの仕事でも必要になることがあると思います。

ただ、ブラウザの設定とか「GUIの設定も含む」と、途端に「長大な手順書を用意して」とか「各自端末を汚す」「個人で設定するのを強いる」とか、そういうことになりがちで…。

そういうとき「インハウスリポジトリから`docker run` のワンライナーで落として実行」などできると、すごく便利なんじゃないか？と思いやってみました。

トレーサビリティが気になる方は、ログ等「立ち上げてアクセスされたら解る仕組み」も自動で設定しておくのも良いかもしれません。


---

[アドベントカレンダー](https://adventar.org/calendars/3022) 、次は四日目 [porinkysan](https://twitter.com/porinkysan) さんの「」 です。

# 参考

以下を参考にさせていただきました。

- どこへ行っても安心！SSHサーバーを踏み台にしてWebアクセスする方法
  - <https://linuxfan.info/ssh-dyamic-forward>
- OpenBox man page
  - <https://www.mankier.com/1/openbox>
- DockerImage : docker-headless-vnc-container
  - <https://github.com/ConSol/docker-headless-vnc-container>
- Supervisorで簡単にデーモン化
  - <https://qiita.com/yushin/items/15f4f90c5663710dbd56>
